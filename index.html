<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Advanced Sales Analytics Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    font-family:'Segoe UI',sans-serif;
    background:#f4f6f9;
    margin:20px;
}

h2{margin-bottom:15px;}

.filters{
    background:white;
    padding:15px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    margin-bottom:20px;
}

select{
    padding:8px;
    margin:5px;
    border-radius:6px;
    border:1px solid #ccc;
}

.card-container{
    display:flex;
    gap:20px;
    flex-wrap:wrap;
    margin-bottom:20px;
}

.card{
    background:white;
    padding:15px;
    border-radius:12px;
    box-shadow:0 4px 15px rgba(0,0,0,0.08);
    flex:1;
    min-width:250px;
}

.card h3{margin:0;font-size:14px;color:#555;}
.card h1{margin:5px 0 0 0;}

.positive{color:green;font-weight:bold;}
.negative{color:red;font-weight:bold;}

canvas{
    background:white;
    padding:15px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    margin-bottom:20px;
}
</style>
</head>

<body>

<h2>ðŸ“Š Advanced Sales Analytics Dashboard</h2>

<div class="filters">
<select id="store"><option value="">All Stores</option></select>
<select id="year"><option value="">All Years</option></select>
<select id="month"><option value="">All Months</option></select>
<select id="product"><option value="">All Products</option></select>
<select id="category"><option value="">All Categories</option></select>
</div>

<div class="card-container">
<div class="card">
<h3>Total Sales</h3>
<h1 id="totalSales">0</h1>
</div>
<div class="card">
<h3>YTD Sales</h3>
<h1 id="ytdSales">0</h1>
</div>
<div class="card">
<h3>Growth % (vs Last Year)</h3>
<h1 id="growthRate">0%</h1>
</div>
</div>

<h3>ðŸ“Š Month on Month Trend</h3>
<canvas id="momChart"></canvas>

<h3>ðŸ“ˆ Year on Year Comparison</h3>
<canvas id="yoyChart"></canvas>

<h3>ðŸ¥§ Category Distribution</h3>
<canvas id="pieChart"></canvas>

<script>

const SHEET_ID="151Stj3jdaqv-FG7CgOYGX87W8QEdDQJwzZNUY9t_aKE";
const URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?`;

let rawData=[];
let momChart,yoyChart,pieChart;

const monthOrder=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

fetch(URL)
.then(res=>res.text())
.then(rep=>{
const json=JSON.parse(rep.substring(47).slice(0,-2));
const rows=json.table.rows;

rawData=rows.map(r=>({
store:r.c[0]?.v,
year:String(r.c[1]?.v),
month:r.c[2]?.v,
product:r.c[3]?.v,
category:r.c[4]?.v,
qty:Number(r.c[5]?.v)||0
})).filter(r=>r.store && r.qty>0);

initFilters();
});

function unique(arr){return [...new Set(arr)]}

function populate(id,values,label){
let sel=document.getElementById(id);
let current=sel.value;
sel.innerHTML=`<option value="">${label}</option>`;
values.sort().forEach(v=>{
if(v) sel.innerHTML+=`<option value="${v}">${v}</option>`;
});
sel.value=current;
}

function initFilters(){
populate("store",unique(rawData.map(d=>d.store)),"All Stores");
populate("year",unique(rawData.map(d=>d.year)),"All Years");
populate("month",unique(rawData.map(d=>d.month))
.sort((a,b)=>monthOrder.indexOf(a)-monthOrder.indexOf(b)),"All Months");
populate("product",unique(rawData.map(d=>d.product)),"All Products");
populate("category",unique(rawData.map(d=>d.category)),"All Categories");

document.querySelectorAll("select").forEach(s=>{
s.addEventListener("change",render);
});

render();
}

function sum(arr){return arr.reduce((a,b)=>a+b.qty,0)}

function growth(oldV,newV){
if(oldV==0) return 0;
return ((newV-oldV)/oldV*100);
}

function render(){

let fStore=store.value;
let fYear=year.value;
let fMonth=month.value;
let fProduct=product.value;
let fCategory=category.value;

let data=rawData.filter(d=>{
return (!fStore||d.store==fStore)
&&(!fYear||d.year==fYear)
&&(!fMonth||d.month==fMonth)
&&(!fProduct||d.product==fProduct)
&&(!fCategory||d.category==fCategory);
});

updateFilters(data);

let total=sum(data);
totalSales.innerText=total;

let selectedYear=fYear || unique(data.map(d=>d.year)).sort().pop();
let ytd=sum(data.filter(d=>d.year==selectedYear));
ytdSales.innerText=ytd;

let prevYear=(parseInt(selectedYear)-1)+"";
let prevTotal=sum(rawData.filter(d=>d.year==prevYear && (!fStore||d.store==fStore)));
let g=growth(prevTotal,ytd);
growthRate.innerHTML=`<span class="${g>=0?'positive':'negative'}">${g.toFixed(1)}%</span>`;

drawMoM(data,selectedYear);
drawYoY(data);
drawPie(data);
}

function updateFilters(data){
populate("year",unique(data.map(d=>d.year)),"All Years");
populate("month",unique(data.map(d=>d.month))
.sort((a,b)=>monthOrder.indexOf(a)-monthOrder.indexOf(b)),"All Months");
populate("product",unique(data.map(d=>d.product)),"All Products");
populate("category",unique(data.map(d=>d.category)),"All Categories");
}

function drawMoM(data,year){

let filtered=data.filter(d=>d.year==year);

let grouped={};
monthOrder.forEach(m=>grouped[m]=0);

filtered.forEach(d=>grouped[d.month]+=d.qty);

let labels=monthOrder.filter(m=>grouped[m]>0);
let values=labels.map(m=>grouped[m]);

if(momChart) momChart.destroy();

momChart=new Chart(document.getElementById("momChart"),{
type:"bar",
data:{labels:labels,datasets:[{label:"Monthly Sales "+year,data:values}]},
options:{responsive:true}
});
}

function drawYoY(data){

let grouped={};
data.forEach(d=>{
if(!grouped[d.year]) grouped[d.year]=0;
grouped[d.year]+=d.qty;
});

let labels=Object.keys(grouped).sort();
let values=labels.map(y=>grouped[y]);

if(yoyChart) yoyChart.destroy();

yoyChart=new Chart(document.getElementById("yoyChart"),{
type:"line",
data:{labels:labels,datasets:[{label:"Yearly Sales",data:values}]},
options:{responsive:true}
});
}

function drawPie(data){

let grouped={};
data.forEach(d=>{
if(!grouped[d.category]) grouped[d.category]=0;
grouped[d.category]+=d.qty;
});

let labels=Object.keys(grouped);
let values=labels.map(c=>grouped[c]);

if(pieChart) pieChart.destroy();

pieChart=new Chart(document.getElementById("pieChart"),{
type:"pie",
data:{labels:labels,datasets:[{data:values}]},
options:{
responsive:true,
plugins:{
legend:{position:"top"}
}
}
});
}

</script>

</body>
</html>
