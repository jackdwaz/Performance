<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sellout Performance Dashboard</title>

<style>
body{
    font-family:Segoe UI, sans-serif;
    background:#f4f6f9;
    margin:20px;
}

h2{
    margin-bottom:20px;
}

.filters{
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.08);
    margin-bottom:20px;
}

select{
    padding:6px;
    margin:5px;
    border-radius:6px;
    border:1px solid #ccc;
}

table{
    width:100%;
    border-collapse:collapse;
    background:white;
    box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

th, td{
    padding:8px;
    text-align:center;
    border:1px solid #eee;
}

th{
    background:#111;
    color:white;
}

.growth-pos{color:green;font-weight:bold;}
.growth-neg{color:red;font-weight:bold;}
</style>
</head>

<body>

<h2>ðŸ“Š Sellout Performance Dashboard</h2>

<div class="filters">
<select id="store"></select>
<select id="location"></select>
<select id="outlet"></select>
<select id="year"></select>
<select id="month" multiple size="4"></select>
<select id="category"></select>
<select id="product"></select>
</div>

<div id="output"></div>

<script>

const SHEET_ID="151Stj3jdaqv-FG7CgOYGX87W8QEdDQJwzZNUY9t_aKE";
const URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?`;

let rawData=[];
const monthOrder=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

fetch(URL)
.then(res=>res.text())
.then(rep=>{
    const json=JSON.parse(rep.substring(47).slice(0,-2));
    const rows=json.table.rows;

    rawData=rows.map(r=>({

        store:clean(r.c[0]?.v),
        location:clean(r.c[1]?.v),
        outlet:clean(r.c[2]?.v),
        year:clean(r.c[3]?.v),
        month:clean(r.c[4]?.v),
        category:clean(r.c[5]?.v),
        product:clean(r.c[6]?.v),
        qty:Number(r.c[7]?.v)||0

    })).filter(r=>r.store && r.qty>0);

    initFilters();
});

function clean(val){
    return String(val||"")
        .replace(/[\u00A0\u2007\u202F]/g,"")
        .trim();
}

function unique(arr){ return [...new Set(arr)]; }
function sum(arr){ return arr.reduce((a,b)=>a+b.qty,0); }

function populate(id, values, label, isMonth=false){
    let sel=document.getElementById(id);
    sel.innerHTML=`<option value="">${label}</option>`;

    if(isMonth){
        monthOrder.forEach(m=>{
            if(values.includes(m)){
                sel.innerHTML+=`<option value="${m}">${m}</option>`;
            }
        });
    } else {
        values.sort().forEach(v=>{
            if(v) sel.innerHTML+=`<option value="${v}">${v}</option>`;
        });
    }
}

function initFilters(){

    populate("store", unique(rawData.map(d=>d.store)), "All Stores");
    populate("location", unique(rawData.map(d=>d.location)), "All Locations");
    populate("outlet", unique(rawData.map(d=>d.outlet)), "All Outlets");
    populate("year", unique(rawData.map(d=>d.year)), "All Years");
    populate("category", unique(rawData.map(d=>d.category)), "All Categories");
    populate("product", unique(rawData.map(d=>d.product)), "All Products");
    populate("month", unique(rawData.map(d=>d.month)), "", true);

    document.querySelectorAll("select").forEach(s=>{
        s.addEventListener("change", render);
    });

    render();
}

function getFilteredData(){

    return rawData.filter(d =>
        (!store.value || d.store === store.value) &&
        (!location.value || d.location === location.value) &&
        (!outlet.value || d.outlet === outlet.value) &&
        (!year.value || d.year === year.value) &&
        (!category.value || d.category === category.value) &&
        (!product.value || d.product === product.value)
    );
}

function render(){

    let data=getFilteredData();
    let selectedMonths=[...month.selectedOptions].map(o=>o.value).filter(v=>v);

    displayMatrix(data, selectedMonths);
}

function displayMatrix(data, selectedMonths){

    let years = unique(data.map(d=>d.year)).sort();

    if(years.length===0){
        output.innerHTML="<b>No Data Found</b>";
        return;
    }

    let html="<table><tr><th>Month</th>";

    years.forEach(y=>{
        let total=sum(data.filter(d=>d.year==y));
        html+=`<th>${y}<br><small>Total: ${total}</small></th>`;
    });

    html+="</tr>";

    let months = selectedMonths.length>0 ? selectedMonths : monthOrder;

    months.forEach(m=>{

        let row=`<tr><td><b>${m}</b></td>`;
        let prevVal=null;

        years.forEach(y=>{
            let val=sum(data.filter(d=>d.year==y && d.month==m));

            let growthHTML="";
            if(prevVal!==null && prevVal>0){
                let g=((val-prevVal)/prevVal*100).toFixed(1);
                let cls=g>=0?"growth-pos":"growth-neg";
                growthHTML=`<div class="${cls}">${g}%</div>`;
            }

            row+=`<td>${val}${growthHTML}</td>`;
            prevVal=val;
        });

        row+="</tr>";
        html+=row;

    });

    html+="</table>";
    output.innerHTML=html;
}

</script>

</body>
</html>
