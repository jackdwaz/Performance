<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sales Performance Dashboard</title>

<style>
body{
    font-family: Arial, sans-serif;
    margin:20px;
    background:#f4f6f9;
}

h2{
    margin-bottom:10px;
}

select{
    padding:6px;
    margin:5px;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    background:white;
}

th,td{
    border:1px solid #ddd;
    padding:8px;
    text-align:center;
}

th{
    background:#222;
    color:white;
}

.positive{color:green;font-weight:bold;}
.negative{color:red;font-weight:bold;}

.card{
    background:white;
    padding:15px;
    margin-top:20px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
</style>
</head>

<body>

<h2>ðŸ“Š Sales Dashboard</h2>

<label>Store:
<select id="store"></select></label>

<label>Year:
<select id="year"></select></label>

<label>Month:
<select id="month"></select></label>

<label>Product Type:
<select id="product"></select></label>

<label>Category:
<select id="category"></select></label>

<div id="output"></div>

<script>

const SHEET_ID = "151Stj3jdaqv-FG7CgOYGX87W8QEdDQJwzZNUY9t_aKE";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

let rawData = [];
const monthOrder = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

fetch(SHEET_URL)
.then(res => res.text())
.then(data => {
    const rows = data.split("\n").slice(1);

    rawData = rows.map(r=>{
        let c = r.split(",");
        return {
            store:c[0]?.trim(),
            year:c[1]?.trim(),
            month:c[2]?.trim(),
            product:c[3]?.trim(),
            category:c[4]?.trim(),
            qty:parseFloat(c[5])||0
        }
    }).filter(r=>r.store && r.qty>0);

    initFilters();
});

function unique(arr){
    return [...new Set(arr)];
}

function initFilters(){
    populate("store", unique(rawData.map(d=>d.store)));
    populate("year", unique(rawData.map(d=>d.year)));
    populate("month", monthOrder);
    populate("product", unique(rawData.map(d=>d.product)));
    populate("category", unique(rawData.map(d=>d.category)));

    document.querySelectorAll("select").forEach(s=>{
        s.addEventListener("change", render);
    });

    render();
}

function populate(id, values){
    let sel = document.getElementById(id);
    sel.innerHTML = "<option value=''>All</option>";
    values.sort().forEach(v=>{
        if(v) sel.innerHTML += `<option value="${v}">${v}</option>`;
    });
}

function render(){

    let fStore = store.value;
    let fYear = year.value;
    let fMonth = month.value;
    let fProduct = product.value;
    let fCategory = category.value;

    let data = rawData.filter(d=>{
        return (!fStore || d.store==fStore)
        && (!fYear || d.year==fYear)
        && (!fMonth || d.month==fMonth)
        && (!fProduct || d.product==fProduct)
        && (!fCategory || d.category==fCategory)
        && d.qty>0;
    });

    updateFilters(data);

    showResults(data);
}

function updateFilters(data){
    populate("year", unique(data.map(d=>d.year)));
    populate("month", unique(data.map(d=>d.month))
        .sort((a,b)=>monthOrder.indexOf(a)-monthOrder.indexOf(b)));
    populate("product", unique(data.map(d=>d.product)));
    populate("category", unique(data.map(d=>d.category)));
}

function sum(arr){
    return arr.reduce((a,b)=>a+b.qty,0);
}

function growth(oldV,newV){
    if(oldV==0) return 0;
    return ((newV-oldV)/oldV*100);
}

function percentHTML(v){
    let cls = v>=0 ? "positive":"negative";
    let sign = v>=0 ? "+":"";
    return `<span class="${cls}">${sign}${v.toFixed(1)}%</span>`;
}

function showResults(data){

    let grouped = {};

    data.forEach(d=>{
        if(!grouped[d.store]) grouped[d.store]={};
        if(!grouped[d.store][d.year]) grouped[d.store][d.year]=[];
        grouped[d.store][d.year].push(d);
    });

    let html="";

    for(let store in grouped){

        html+=`<div class="card"><h3>${store}</h3>`;

        for(let year in grouped[store]){

            let yearData = grouped[store][year];
            let prevYear = (parseInt(year)-1)+"";

            let prevData = rawData.filter(d=>d.store==store && d.year==prevYear);

            let ytdTotal = sum(yearData);
            let prevYTD = sum(prevData);
            let ytdGrowth = growth(prevYTD,ytdTotal);

            html+=`<table>
            <tr>
            <th colspan="5">${year} | YTD: ${ytdTotal} | ${percentHTML(ytdGrowth)}</th>
            </tr>
            <tr>
            <th>Month</th>
            <th>Qty</th>
            <th>Growth</th>
            <th>MTD</th>
            <th>YTD</th>
            </tr>`;

            let months = unique(yearData.map(d=>d.month))
            .sort((a,b)=>monthOrder.indexOf(a)-monthOrder.indexOf(b));

            let runningYTD = 0;

            months.forEach(m=>{
                let current = sum(yearData.filter(d=>d.month==m));
                let prevMonth = sum(prevData.filter(d=>d.month==m));
                let g = growth(prevMonth,current);

                runningYTD += current;

                html+=`<tr>
                <td>${m}</td>
                <td>${current}</td>
                <td>${percentHTML(g)}</td>
                <td>${current}</td>
                <td>${runningYTD}</td>
                </tr>`;
            });

            html+="</table><br>";
        }

        html+="</div>";
    }

    output.innerHTML = html || "<p>No data found</p>";
}

</script>
</body>
</html>
