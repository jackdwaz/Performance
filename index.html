<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Final Stable Sales Matrix</title>

<style>
body{
    font-family:'Segoe UI',sans-serif;
    background:#f4f6f9;
    margin:20px;
}

h2{margin-bottom:20px;}

.filters{
    background:white;
    padding:15px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    margin-bottom:20px;
}

select{
    padding:6px;
    margin:5px;
    border-radius:6px;
    border:1px solid #ccc;
}

table{
    width:100%;
    border-collapse:collapse;
    background:white;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

th,td{
    padding:8px;
    text-align:center;
    border:1px solid #eee;
}

th{
    background:#111;
    color:white;
}

.growth-pos{color:green;font-weight:bold;}
.growth-neg{color:red;font-weight:bold;}
</style>
</head>

<body>

<h2>ðŸ“Š Final Stable Sales Matrix</h2>

<div class="filters">
<select id="store"></select>
<select id="location"></select>
<select id="year"></select>
<select id="month" multiple size="4"></select>
<select id="product"></select>
<select id="category"></select>
</div>

<div id="output"></div>

<script>

const SHEET_ID="151Stj3jdaqv-FG7CgOYGX87W8QEdDQJwzZNUY9t_aKE";
const URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?`;

let rawData=[];
const monthOrder=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

fetch(URL)
.then(res=>res.text())
.then(rep=>{
const json=JSON.parse(rep.substring(47).slice(0,-2));
const rows=json.table.rows;

rawData=rows.map(r=>({
store:r.c[0]?.v,
location:r.c[1]?.v,
year:String(r.c[2]?.v),
month:r.c[3]?.v,
product:r.c[4]?.v,
category:r.c[5]?.v,
qty:Number(r.c[6]?.v)||0
})).filter(r=>r.store && r.qty>0);

initFilters();
});

function unique(arr){return [...new Set(arr)]}
function sum(arr){return arr.reduce((a,b)=>a+b.qty,0)}

function populateSelect(id, values, label, sortMonths=false){
let sel=document.getElementById(id);
let current=[...sel.selectedOptions].map(o=>o.value);

sel.innerHTML=`<option value="">${label}</option>`;

if(sortMonths){
values.sort((a,b)=>monthOrder.indexOf(a)-monthOrder.indexOf(b));
}else{
values.sort();
}

values.forEach(v=>{
if(v) sel.innerHTML+=`<option value="${v}">${v}</option>`;
});

current.forEach(val=>{
let opt=[...sel.options].find(o=>o.value===val);
if(opt) opt.selected=true;
});
}

function initFilters(){
refreshAllDropdowns();
document.querySelectorAll("select").forEach(s=>{
s.addEventListener("change",onFilterChange);
});
render();
}

function getFilters(){
return{
store:store.value,
location:location.value,
year:year.value,
product:product.value,
category:category.value,
months:[...month.selectedOptions].map(o=>o.value).filter(v=>v)
};
}

function filterData(filters){
return rawData.filter(d=>{
return (!filters.store||d.store==filters.store)
&&(!filters.location||d.location==filters.location)
&&(!filters.year||d.year==filters.year)
&&(!filters.product||d.product==filters.product)
&&(!filters.category||d.category==filters.category);
});
}

function refreshAllDropdowns(){

let filters=getFilters();
let filtered=filterData(filters);

populateSelect("store",
unique(rawData.map(d=>d.store)),
"All Stores");

populateSelect("location",
unique(
(filters.store?
rawData.filter(d=>d.store==filters.store)
:rawData).map(d=>d.location)
),
"All Locations");

populateSelect("year",
unique(filtered.map(d=>d.year)),
"All Years");

populateSelect("product",
unique(filtered.map(d=>d.product)),
"All Products");

populateSelect("category",
unique(filtered.map(d=>d.category)),
"All Categories");

populateSelect("month",
unique(filtered.map(d=>d.month)),
"",
true);
}

function onFilterChange(){
refreshAllDropdowns();
render();
}

function render(){

let filters=getFilters();
let data=filterData(filters);

displayMatrix(data,filters.months);
}

function displayMatrix(data,selectedMonths){

let years=unique(data.map(d=>d.year)).sort();

if(years.length===0){
output.innerHTML="No Data Found";
return;
}

let html="<table><tr><th>Month</th>";

years.forEach(y=>{
let total=sum(data.filter(d=>d.year==y));
html+=`<th>${y}<br><small>Total: ${total}</small></th>`;
});

html+="</tr>";

let months = selectedMonths.length>0 ? selectedMonths : monthOrder;

months.forEach(m=>{

let row=`<tr><td><b>${m}</b></td>`;
let prevVal=null;

years.forEach(y=>{
let val=sum(data.filter(d=>d.year==y && d.month==m));

let growthHTML="";
if(prevVal!==null && prevVal>0){
let g=((val-prevVal)/prevVal*100).toFixed(1);
let cls=g>=0?"growth-pos":"growth-neg";
growthHTML=`<div class="${cls}">${g}%</div>`;
}

row+=`<td>${val}${growthHTML}</td>`;
prevVal=val;
});

row+="</tr>";
html+=row;

});

html+="</table>";
output.innerHTML=html;
}

</script>

</body>
</html>
